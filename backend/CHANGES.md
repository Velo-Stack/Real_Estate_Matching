# ููุฎุต ุงูุชุนุฏููุงุช ูู ุงูู Backend โ

ูุฐุง ุงูููู ููุซู ุฌููุน ุงูุชุนุฏููุงุช ุงูุชู ุชููุช ุญุชู ุงูุขู ูู ูุฌูุฏ `backend/` โ ุชุบููุฑุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (Prisma), ุชุญุฏูุซุงุช ุนูู ุงูู controllersุ ูููุงุญุธุงุช ุนูู ุงูููุฌุฑูุดู ูุงูุญุงูุฉ ุงูุญุงููุฉ.

---

## ๐ง ุงูุชุนุฏููุงุช ุงูุฃุณุงุณูุฉ (ููุฎูุต)

- ุชุนุฏูู **`backend/prisma/schema.prisma`**:
  - ุฅุถุงูุฉ enums ุฌุฏูุฏุฉ: `OfferPurpose`, `ContractNature`, `NotificationType`.
  - ุฅุถุงูุฉ ุญููู ุฌุฏูุฏุฉ ุฅูู ุงูู models:
    - ูู `Offer`: `offerPurpose OfferPurpose?`, `contractNature ContractNature?`, `ownerBrokersCount Int @default(1)`, ูุนูุงูุฉ `brokers` (`OfferBroker[]`) ู`notifications`.
    - ูู `Request`: ููุณ ุงูุญููู (ุงุฎุชูุงุฑู/ูุงุจู ููุชูุณูุน) ู`ownerBrokersCount`.
  - ุฅุถุงูุฉ ููุงุฐุฌ ุฌุฏูุฏุฉ (models):
    - `OfferBroker` (ุนูุงูุฉ Offer <-> Broker ูุน `sharePercent`, `role`)
    - `City` ู `Neighborhood` (ุนูุงูุฉ 1:N)
    - `Team` ู `TeamMember` (ูุฅุฏุงุฑุฉ ุงููุฑู)
    - `Message` (ูุฑุงุณูุงุช ุฏุงุฎููุฉ)
  - ุชูุณูุน `Notification` ููุดูู ุนูุงูุงุช ุงุฎุชูุงุฑูุฉ (`match`, `offer`, `request`, `message`) ูุญูู `type` ู`payload`.
  - ุชุญุฏูุซ `User` ูุฅุถุงูุฉ ุนูุงูุงุช: `sentMessages`, `receivedMessages`, `teamMembers`, `offerBrokerEntries`.

- ุชุญุฏูุซ **`backend/src/controllers/notifications.controller.js`**:
  - ุฅุฒุงูุฉ ุงูุญูู ุบูุฑ ุงูููุฌูุฏ `conversation` ูู ุงุณุชุนูุงูุงุช ุงูู include (ุชุณุจุจ ุฎุทุฃ ุนูุฏ ุฌูุจ ุงูุฅุดุนุงุฑุงุช).
  - ุชุถููู ุจูุงูุงุช `user` ูู ุงูู include ูุนุฑุถ ุตุงุญุจ ุงูุฅุดุนุงุฑ.
  - (ููุงุญุธุฉ: ูู ููุถููู `message` ูู ุงูููุงูุฉ ูุชูุงุฏู ุฃุฎุทุงุก ูุจู ุชุทุจูู ุงูููุฌุฑูุดู ุจุงููุงูู.)

- ุชูููุฐ ุฃูุฑ `npx prisma generate` ุจูุฌุงุญ ุจุนุฏ ุชุนุฏูู ุงูู schema (ุชูููุฏ Prisma Client ุงูุฌุฏูุฏ).

---

## โ๏ธ ุญุงูุฉ ุงูููุฌุฑูุดู ุงูุญุงููุฉ

- ุชู ุฅูุดุงุก ููุฌุฑูุดู ุจุงุณู: `20260131194915_add_offer_fields_and_models` ุชุญุช `backend/prisma/migrations/`.
- ุนูุฏ ูุญุงููุฉ ุชุทุจูู ุงูููุฌุฑูุดู ูุงุฌููุง ุฃุฎุทุงุก ูุชุนููุฉ ุจุฅุถุงูุฉ ุนููุฏ `type` ูู `Notification` ูุฃู ููุงู ุตููููุง ูุฏููุฉ ุชุญุชูู ุนูู NULL. ุญุงูููุง ุชุนุฏูู ุงูุญูู ููููู `nullable` ุซู ุฅุนุงุฏุฉ ุฅูุดุงุฆู ููู ุงูููุฌุฑูุดู ูุดู ุฃุซูุงุก ุงูุชุทุจูู ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ.
- ุงูุฎูุงุตุฉ: ููุฌุฏ ููุฌุฑูุดู ูููุดุฃ ููููู ูู ููุทุจู ุจูุฌุงุญ. ูุง ุชูู ุจุญุฐู ุงููููุงุชุ ูููู **ูุฌุจ ุฅุตูุงุญ ุณูุฑุจุช ุงูููุฌุฑูุดู ุฃู ุฅุฌุฑุงุก Backfill** ูุจู ุฅุนุงุฏุฉ ุงูุชุทุจูู ุนูู ูุงุนุฏุฉ ุงูุฅูุชุงุฌ.

---

## ๐ ูุงุฆูุฉ ุงููููุงุช ุงููุชุฃุซุฑุฉ (ุชูุตูู)

- backend/prisma/schema.prisma  โ **ูุนุฏู** (ุฅุถุงูุงุช enums ูmodels ูุญููู)
- backend/prisma/migrations/20260131194915_add_offer_fields_and_models/ โ **ููุฌูุฏ (ุบูุฑ ูุทุจู ุจุงููุงูู)**
- backend/src/controllers/notifications.controller.js โ **ูุนุฏู** (ุฅุตูุงุญ include)
- backend/src/utils/prisma.js โ **ูุณุชุฎุฏู** (Prisma client; ุชู ุชุฌุฏูุฏ client ุจุนุฏ ุชุบููุฑุงุช schema)
- backend/package.json โ (ุฎุงุตูุฉ `prisma.seed` ุชุดูุฑ ูู `prisma/seed.js`) โ ูุฐููุฑ ููุชุญุฏูุซ ูุงุญููุง ูููุก ุงููุฏู/ุงูุฃุญูุงุก/ูุฑู/ุจูุงูุงุช ูุณุทุงุก ุฅู ูุฒู.

---

## โ ููุงุท ูุชุงุจุนุฉ ููุชุฑุญุฉ (ุฎุทูุงุช ุนูููุฉ)

1. **Backfill ููุฅุดุนุงุฑุงุช**: ุฃุถู ุณูุฑุจุชูุง ุตุบูุฑูุง (Node + Prisma) ูููุฃ `Notification.type` ููู rows ุงููุฏููุฉ ุฃู ูุนููู ูููุฉ ุงูุชุฑุงุถูุฉ ูุคูุชุฉ ูุจู ุชุทุจูู ููุฌุฑูุดู ููุฑุถ ุนุฏู ุงูู null.
2. **ุชุทุจูู ุงูููุฌุฑูุดู ูู ุจูุฆุฉ ุงุฎุชุจุงุฑ (staging)**: ูุง ุชุทุจูู ูุจุงุดุฑุฉ ุนูู ุงูุฅูุชุงุฌ ูุจู ุงูุชุญูู. ูู ุจุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช ุซู ุดุบูู ุงูููุฌุฑูุดู ุนูู staging.
3. **ุชุญุฏูุซ ุงูู seed** (`backend/prisma/seed.js`) ูููุฏุฑูุฌ ุจูุงูุงุช ุงููุฏู/ุงูุฃุญูุงุก/ูุฑู ูููุฐุฌูุฉ ูุงุฎุชุจุงุฑุงุช ุงูู API. ุญุงููุงู ุงูููู ููุชูุญ ููููุน ุงูุนูู ูููู ูู ููุญุฏูุซ ุชููุงุฆููุง.
4. **ุฅุถุงูุฉ controllers ูroutes** ููู models ุงูุฌุฏูุฏุฉ:
   - `backend/src/controllers/cities.controller.js` + routes `GET /cities`, `GET /cities/:id/neighborhoods`.
   - `backend/src/controllers/teams.controller.js` + routes ูุฅุฏุงุฑุฉ ุงููุฑู.
   - `backend/src/controllers/messages.controller.js` + routes ููุฑุณุงุฆู (`POST /messages`, `GET /messages`).
   - Endpoints ูุฅุฏุงุฑุฉ `OfferBroker` (`/offers/:id/brokers`).
5. **ูุชุงุจุฉ Validation ูุฑูุฒู** (`backend/src/utils/validation.js`) ุจุงุณุชุฎุฏุงู `Joi` ุซู ุงุณุชุจุฏุงู ุงููุญูุต ุงููุจุนุซุฑุฉ ูู ุงูู controllers.
6. **ุงุฎุชุจุงุฑ ุงูุชูุงูู**: ุชุญุฏูุซ ูุงุฎุชุจุงุฑ Matching flow ู Notifications ุจุนุฏ ุฅุถุงูุฉ ุงูุญููู/ุงูุนูุงูุงุช.

---

## ๐ ููุงุญุธุงุช ูุฃุฎุทุงุก ูููุงุญูุธุฉ

- ุงูุฎุทุฃ ุงูุฐู ุธูุฑ ุนูุฏ ุทูุจ `GET /api/notifications` ูุงู ุจุณุจุจ ุงุณุชุนูุงู ูุชุถููู ุญูููุง ุบูุฑ ููุฌูุฏ (`conversation`) ูุชู ุฅุตูุงุญู. ุชุญูู ูู ุฃู ุฌููุน ุงูู includes ูู ุจุงูู controllers ูุฑุฆูุฉ ูููุฌูุฏุฉ ูู `schema.prisma`.
- ุชุฃูุฏ ูู ุฃู ุฃู ุชุบููุฑุงุช ูุงุญูุฉ ุนูู ุงูู schema ุชูุชุจุน ุจุฎุทูุงุช Backfill ุฅู ูุงู ููุงู ุจูุงูุงุช ูุฏููุฉ ุชุชุฃุซุฑ.

---

## ๐ ุงูุฎูุทูุฉ ุงูุชุงููุฉ ุงูููุชุฑุญุฉ

**ูุณู ุงุฌุชูุงุน ุณุฑูุน ูุน ูุฏูุฑ ุงูููุชุฌ/ุงูู PO** ูุชุฃููุฏ ููุงุนุฏ Backfill ูุงููุฑุงุฑุงุช ุงูุชุงููุฉ:
- ูู ูุฌุนู `Notification.type` ุฅูุฒุงูููุง ูููู ูููุฃ ุงูููู ุงููุฏููุฉุ
- ูุฑุงุฑ ููุงุฆู ุจุฎุตูุต `OfferBroker` (relation) ุฃู ูุฌุฑุฏ ุญูู `ownerBrokersCount`.

ุจุนุฏ ุงูููุงููุฉุ ุฃุนุฏู ุณูุฑุจุช Backfill ูุฃุทุจูู ุงูููุฌุฑูุดู ุนูู ุจูุฆุฉ staging ูุงุฎุชุจุงุฑ ุงูุชุฃุซูุฑ.

---

ุฅุฐุง ุชุฑูุฏุ ุฃูุนุฏู ูู ููููุง ุขุฎุฑู ุจุตูุบุฉ `PATCH_NOTES.md` ููุตู ุฎุทูุฉ-ุจุฎุทูุฉ ูุน ุฃูุงูุฑ ุงูู Prisma ุงููุงุฒูุฉ (SQL hints + Node script skeleton) ูุชูููุฐ ุงูู Backfill ูุงูููุฌุฑูุดู ุจุฃูุงู. โจ
